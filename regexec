#!/usr/bin/env python2

import re
import sys
import string
import argparse
import subprocess

import argparse
parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)

parser.add_argument(
    "-e", 
    help="The (python2) regular expression", 
    default=r"\[include (.+)\]"
)

parser.add_argument(
    "-c", 
    help="The command to run with the expression's match groups as arguments and who's output replaces the match", 
    default=r"cat \1"
)

parser.add_argument(
    "-v", 
    help="The verbosity level", 
    default=0,
    type=int
)

args = parser.parse_args()

def verbose_log(s, l):
    if args.v > l:
        print(s)

p = re.compile(args.e)

inp = sys.stdin.read()
out = ""

matches = p.finditer(inp)

inp_index = 0
for match in matches:
    verbose_log("lastindex: " + str(match.lastindex), 1)
    span = match.span()
    
    out += inp[inp_index:span[0]]
    inp_index = span[1]

    new_c = args.c
    for index in xrange(1, match.lastindex + 1):
        verbose_log("$" + str(index) + ": " + match.group(index), 1)
        new_c = string.replace(new_c, "\\" + str(index), match.group(index))
        verbose_log("new_c: " + new_c, 1)

    suboutput = subprocess.check_output(new_c, shell=True)
    verbose_log("suboutput: " + suboutput, 1)
    out += suboutput

out += inp[inp_index:]

print(out),
